worker_processes auto;

events {
    worker_connections 8192;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # -------- Networking/Perf defaults --------
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 60s;
    types_hash_max_size 2048;

    # -------- Real client IP from ALB (trust only ALB subnets) --------
    set_real_ip_from 10.0.1.0/24;
    set_real_ip_from 10.0.2.0/24;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # --------- Structured logging (JSON) ---------
    log_format rich escape=json
      '{'
        '"time":"$time_iso8601",'
        '"scheme":"$scheme",'
        '"host":"$host",'
        '"method":"$request_method",'
        '"uri":"$request_uri",'
        '"args":"$args",'
        '"protocol":"$server_protocol",'
        '"status":$status,'
        '"bytes_sent":$bytes_sent,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_length":$request_length,'
        '"request_time":$request_time,'
        '"upstream_addr":"$upstream_addr",'
        '"upstream_status":"$upstream_status",'
        '"upstream_connect_time":"$upstream_connect_time",'
        '"upstream_header_time":"$upstream_header_time",'
        '"upstream_response_time":"$upstream_response_time",'
        '"remote_addr":"$remote_addr",'
        '"x_forwarded_for":"$http_x_forwarded_for",'
        '"referrer":"$http_referer",'
        '"user_agent":"$http_user_agent",'
        '"trace_id":"$http_x_amzn_trace_id",'
        '"req_id":"$request_id"'
      '}';

    client_body_buffer_size 2m;

    log_format active_call_body escape=json
      '{'
        '"time":"$time_iso8601",'
        '"method":"$request_method",'
        '"uri":"$request_uri",'
        '"status":$status,'
        '"content_type":"$http_content_type",'
        '"remote_addr":"$remote_addr",'
        '"x_forwarded_for":"$http_x_forwarded_for",'
        '"user_agent":"$http_user_agent",'
        '"trace_id":"$http_x_amzn_trace_id",'
        '"req_id":"$request_id",'
        '"request_length":$request_length,'
        '"request_body":"$request_body"'
      '}';

    map $request_uri $log_active_call_body {
        default 0;
        ~^/api/active-call/ 1;
    }

    access_log /dev/stdout rich;
    error_log  /dev/stderr info;

    log_format debug_format escape=json
      '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"method":"$request_method",'
        '"original_uri":"$request_uri",'
        '"status":$status,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"bytes_sent":$bytes_sent,'
        '"user_agent":"$http_user_agent",'
        '"trace_id":"$http_x_amzn_trace_id",'
        '"req_id":"$request_id",'
        '"fastcgi_script_name":"$fastcgi_script_name",'
        '"args":"$args",'
        '"request_body":"$request_body"'
      '}';

    server {
        listen 80;
        server_name multi-tenant.viveri-tech.com;
        root /var/www/html/public;
        index index.php index.html;

        access_log /dev/stdout active_call_body if=$log_active_call_body;

        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_comp_level 6;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

        server_tokens off;

        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options DENY always;
        add_header Referrer-Policy no-referrer-when-downgrade always;
        add_header X-XSS-Protection "1; mode=block" always;
        # add_header Content-Security-Policy "default-src 'self'" always;

        add_header X-Request-Id $request_id always;

        client_max_body_size 32m;
        client_header_buffer_size 4k;
        large_client_header_buffers 8 16k;
        client_body_timeout 60s;
        client_header_timeout 60s;
        keepalive_timeout 60s;
        send_timeout 60s;

        location = /css/theme.css {
            include fastcgi.conf;
            fastcgi_pass   localhost:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME $document_root/index.php;
            fastcgi_param  QUERY_STRING     $query_string;

            fastcgi_param  HTTP_X_AMZN_TRACE_ID $http_x_amzn_trace_id;
            fastcgi_param  HTTP_X_REQUEST_ID     $request_id;
        }

        location /api/ {
            access_log /dev/stdout debug_format;
            set $original_uri $request_uri;
            try_files $uri $uri/ /index.php?$query_string;
        }

        # Health check endpoint for ALB
        location = /health-check {
            access_log /dev/stdout debug_format;
            # Temporarily allow all for debugging
            # allow 10.0.1.0/24;
            # allow 10.0.2.0/24;
            # deny all;

            # Simple health check response
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            include fastcgi.conf;
            fastcgi_pass   localhost:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;

            fastcgi_param  HTTP_X_AMZN_TRACE_ID $http_x_amzn_trace_id;
            fastcgi_param  HTTP_X_REQUEST_ID     $request_id;
            fastcgi_param  HTTP_X_FORWARDED_FOR  $proxy_add_x_forwarded_for;
            fastcgi_param  HTTP_X_ORIGINAL_URI   $request_uri;

            fastcgi_connect_timeout 60s;
            fastcgi_send_timeout    60s;
            fastcgi_read_timeout    60s;
            fastcgi_buffer_size     64k;
            fastcgi_buffers         8 64k;
            fastcgi_busy_buffers_size 128k;
            fastcgi_temp_file_write_size 128k;

            fastcgi_hide_header X-Powered-By;
        }

        location ~ ^/(fpm-status|fpm-ping)$ {
            access_log off;
            allow 10.0.0.0/8;
            deny all;

            include fastcgi.conf;
            fastcgi_pass localhost:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        }

        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        location ~ /\.ht {
            deny all;
        }

        location ~ /\.(env|git|svn) {
            deny all;
        }

        location ~* /(?:uploads|files|wp-content|wp-includes|akismet)/.*\.php$ {
            deny all;
        }
    }

    # ---- Catch-all block to drop unmatched traffic ----
    server {
        listen 80 default_server;
        server_name _;

        # Only allow health checks from ALB subnets
        location = /health-check {
            access_log off;
            allow 10.0.1.0/24;
            allow 10.0.2.0/24;
            deny all;

            # Simple health check response
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Return 404 for all other paths and hostless requests
        location / {
            return 404;
        }
    }
}
