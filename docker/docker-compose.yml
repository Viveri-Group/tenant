services:
  tenant_api-file-sync:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: tenant_api-file-sync
    volumes:
      - tenant_api-app-files:/target
    networks:
      - tenant_api-network
    command: >
      sh -c "
        echo 'Syncing fresh application files to shared volume...'
        cp -rf /var/www/html/. /target/
        echo 'File sync completed - fresh files available'
        ls -la /target/public/ | head -10
      "
    restart: "no"

  tenant_api-init:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: tenant_api-init
    env_file:
      - .env
    depends_on:
      - tenant_api-file-sync
      - tenant_api-mysql
      - tenant_api-redis
    volumes:
      - tenant_api-app-files:/var/www/html
    networks:
      - tenant_api-network
    command: >
      sh -c "
        echo 'Waiting for MySQL to be fully ready...'
        sleep 10
        i=1
        while [ \$i -le 30 ]; do
          if mysql -h tenant_api-mysql -u \"\${DB_USERNAME}\" -p\"\${DB_PASSWORD}\" -e 'SELECT 1' >/dev/null 2>&1; then
            echo 'MySQL connection successful!'
            break
          fi
          echo \"Attempt \$i: MySQL not ready yet, waiting 5 seconds...\"
          sleep 5
          i=\$((\$i + 1))
        done
        echo 'Testing database connection...'
        php artisan tinker --execute='DB::connection()->getPdo(); echo \"Laravel database connection successful\\n\";'
        echo 'Running migrations...'
        php artisan migrate --force
        echo 'Migrations completed!'
        exit 0
      "
    restart: "no"

  tenant_api-web:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: tenant_api-web
    ports:
      - '9000:9000'
    env_file:
      - .env
    depends_on:
      - tenant_api-init
      - tenant_api-mysql
      - tenant_api-redis
    volumes:
      - tenant_api-app-files:/var/www/html
      - tenant_api-php-logs:/var/log
    networks:
      - tenant_api-network
    cap_add:
      - SYS_PTRACE

  tenant_api-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: tenant_api-worker
    env_file:
      - .env
    depends_on:
      - tenant_api-init
      - tenant_api-mysql
      - tenant_api-redis
    volumes:
      - tenant_api-worker-logs:/var/log
    networks:
      - tenant_api-network
    restart: unless-stopped
    command: ["supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf", "-n"]
    cap_add:
      - SYS_PTRACE

  tenant_api-caddy:
    image: caddy:latest
    container_name: tenant_api-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/Caddyfile:/etc/caddy/Caddyfile
      - tenant_api-app-files:/var/www/html
    depends_on:
      - tenant_api-web
    networks:
      - tenant_api-network

  tenant_api-mysql:
    image: mysql:8.0
    container_name: tenant_api-mysql
    ports:
      - '3306:3306'
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - tenant_api-mysql-data:/var/lib/mysql
    networks:
      - tenant_api-network
    command: --sort_buffer_size=4096M --slow_query_log=1 --slow_query_log_file=/var/log/mysql/slow.log --long_query_time=1

  tenant_api-redis:
    image: redis:7-alpine
    container_name: tenant_api-redis
    ports:
      - '6379:6379'
    volumes:
      - tenant_api-redis-data:/data
    networks:
      - tenant_api-network

networks:
  tenant_api-network:
    driver: bridge

volumes:
  tenant_api-build-folder:
  tenant_api-app-files:
  tenant_api-php-logs:
  tenant_api-worker-logs:
  tenant_api-mysql-data:
  tenant_api-redis-data: